WITH count_table AS
(SELECT wall_type, 
  CASE WHEN grade IN ('V6-V7', 'V6') THEN 'V6' 
  WHEN grade IN ('V7-V8', 'V7') THEN 'V7'
  ELSE grade END AS grade_,
  COUNT(wall_type) AS count_
FROM dataframe
GROUP BY wall_type, grade_
ORDER BY count_ DESC),

filter_table AS
(SELECT wall_type,
  CASE WHEN grade IN ('V6-V7', 'V6') THEN 'V6' 
  WHEN grade IN ('V7-V8', 'V7') THEN 'V7'
  ELSE grade END AS grade_,
  date_,
  location,
  setter,
  description,
  grade AS vgrade,
  LOWER(wall_type) AS wall_type,
  LOWER(hold_type) AS hold_type,
  LOWER(style) AS style
FROM dataframe
ORDER BY wall_type, grade_),

hover_info AS
(SELECT wall_type, grade_,
  date_,
  location,
  setter,
  description,
  hold_type,
  style
FROM filter_table
GROUP BY wall_type, grade_
HAVING MIN(date_)
ORDER BY date_)

SELECT c.wall_type, c.grade_, c.count_,
  h.date_,
  h.location,
  h.setter,
  h.description,
  h.hold_type,
  h.style
FROM count_table c
LEFT JOIN hover_info h
ON c.wall_type=h.wall_type AND c.grade_=h.grade_
;
